#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTPUT_FILE="${1:-$ROOT_DIR/scripts/perf/compile-baseline.toml}"

run_lane() {
    local lane="$1"
    shift

    local start end elapsed
    start="$(date +%s)"
    printf 'Running compile lane: %s\n' "$lane" >&2
    (cd "$ROOT_DIR" && "$@" >/dev/null)
    end="$(date +%s)"
    elapsed="$((end - start))"
    printf '%s' "$elapsed"
}

wgpui_check_s="$(run_lane wgpui_check cargo check -p wgpui)"
desktop_check_s="$(run_lane desktop_check cargo check -p autopilot-desktop)"
wgpui_smoke_test_s="$(run_lane wgpui_smoke_test cargo test -p wgpui markdown::renderer::tests -- --nocapture)"

mkdir -p "$(dirname "$OUTPUT_FILE")"
cat > "$OUTPUT_FILE" <<BASELINE
# Generated by scripts/perf/compile-baseline.sh
# Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
# Machine: $(uname -srm)
BUDGET_FACTOR_PERCENT=125
WGPUI_CHECK_SECONDS=${wgpui_check_s}
DESKTOP_CHECK_SECONDS=${desktop_check_s}
WGPUI_SMOKE_TEST_SECONDS=${wgpui_smoke_test_s}
BASELINE

printf 'Baseline written: %s\n' "$OUTPUT_FILE"
printf 'wgpui_check=%ss desktop_check=%ss wgpui_smoke_test=%ss\n' \
    "$wgpui_check_s" "$desktop_check_s" "$wgpui_smoke_test_s"
