#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTPUT_FILE="${1:-$ROOT_DIR/scripts/perf/microbench-baseline.toml}"

run_bench() {
    printf 'Running microbench suite: text_scene_microbench\n' >&2
    (
        cd "$ROOT_DIR" && \
            cargo bench -p wgpui --bench text_scene_microbench -- --noplot >/dev/null
    )
}

estimate_file() {
    local rel="$1"
    printf '%s/target/criterion/%s/new/estimates.json' "$ROOT_DIR" "$rel"
}

read_point_estimate() {
    local file="$1"
    if [[ ! -f "$file" ]]; then
        printf 'Missing estimate file: %s\n' "$file" >&2
        return 1
    fi

    local value
    if command -v jq >/dev/null 2>&1; then
        value="$(jq -r '.mean.point_estimate // empty' "$file")"
    else
        value="$(sed -E 's/.*"mean":\\{"confidence_interval":\\{[^}]*\\},"point_estimate":([0-9.]+).*/\1/' "$file")"
    fi
    if [[ -z "$value" ]]; then
        printf 'Could not parse point_estimate from: %s\n' "$file" >&2
        return 1
    fi
    awk "BEGIN { printf \"%.0f\", $value }"
}

run_bench

scene_build_1k_ns="$(read_point_estimate "$(estimate_file 'micro_scene/build_quads/1000')")"
text_measure_1kb_ns="$(read_point_estimate "$(estimate_file 'micro_text/measure_styled_mono_1kb')")"
text_layout_1kb_ns="$(read_point_estimate "$(estimate_file 'micro_text/layout_styled_mono_1kb')")"

mkdir -p "$(dirname "$OUTPUT_FILE")"
cat > "$OUTPUT_FILE" <<BASELINE
# Generated by scripts/perf/microbench-baseline.sh
# Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
# Criterion estimates are in nanoseconds (point_estimate).
MICRO_BUDGET_FACTOR_PERCENT=130
SCENE_BUILD_1000_QUADS_NS=${scene_build_1k_ns}
TEXT_MEASURE_1KB_NS=${text_measure_1kb_ns}
TEXT_LAYOUT_1KB_NS=${text_layout_1kb_ns}
BASELINE

printf 'Baseline written: %s\n' "$OUTPUT_FILE"
printf 'scene_build_1k=%sns text_measure_1kb=%sns text_layout_1kb=%sns\n' \
    "$scene_build_1k_ns" "$text_measure_1kb_ns" "$text_layout_1kb_ns"
