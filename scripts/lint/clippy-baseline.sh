#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTPUT_FILE="${1:-$ROOT_DIR/scripts/lint/clippy-baseline.toml}"

run_lane() {
    local lane="$1"
    shift

    local tmp
    tmp="$(mktemp)"
    printf 'Running clippy lane: %s\n' "$lane" >&2

    if ! (cd "$ROOT_DIR" && "$@" >"$tmp" 2>&1); then
        cat "$tmp" >&2
        rm -f "$tmp"
        printf 'Lane failed: %s\n' "$lane" >&2
        exit 1
    fi

    local count
    count="$(rg -c '^warning:' "$tmp" 2>/dev/null || true)"
    if [[ -z "$count" ]]; then
        count=0
    fi

    rm -f "$tmp"
    printf '%s' "$count"
}

lib_warnings="$(run_lane lib cargo clippy --workspace --lib -- -W clippy::all)"
test_warnings="$(run_lane tests cargo clippy --workspace --tests -- -W clippy::all -A clippy::unwrap_used -A clippy::expect_used -A clippy::panic)"
example_warnings="$(run_lane examples cargo clippy -p wgpui --examples --features desktop -- -W clippy::all)"

mkdir -p "$(dirname "$OUTPUT_FILE")"
cat > "$OUTPUT_FILE" <<BASELINE
# Generated by scripts/lint/clippy-baseline.sh
# Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
LIB_WARNINGS=${lib_warnings}
TEST_WARNINGS=${test_warnings}
EXAMPLE_WARNINGS=${example_warnings}
BASELINE

printf 'Baseline written: %s\n' "$OUTPUT_FILE"
printf 'lib=%s tests=%s examples=%s\n' "$lib_warnings" "$test_warnings" "$example_warnings"
