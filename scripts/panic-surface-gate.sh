#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BASELINE_FILE="$ROOT_DIR/docs/ci/panic-surface-baseline.env"
MODE="${1:-check}"

count_pattern() {
  local pattern="$1"
  (
    cd "$ROOT_DIR"
    rg -F -n "$pattern" apps crates \
      --glob '*.rs' \
      --glob '!**/tests/**' \
      --glob '!**/test/**' \
      --glob '!**/examples/**' \
      --glob '!**/benches/**' \
      --glob '!**/target/**' \
      --glob '!**/fixtures/**' \
      | wc -l | tr -d ' '
  )
}

unwrap_count="$(count_pattern '.unwrap(')"
expect_count="$(count_pattern '.expect(')"
panic_count="$(count_pattern 'panic!(')"
total_count="$((unwrap_count + expect_count + panic_count))"

print_counts() {
  echo "panic-surface counts (production filter):"
  echo "  unwrap=${unwrap_count}"
  echo "  expect=${expect_count}"
  echo "  panic=${panic_count}"
  echo "  total=${total_count}"
}

write_baseline() {
  mkdir -p "$(dirname "$BASELINE_FILE")"
  cat > "$BASELINE_FILE" <<BASELINE
# Generated by scripts/panic-surface-gate.sh snapshot
PANIC_SURFACE_BASELINE_UNWRAP=${unwrap_count}
PANIC_SURFACE_BASELINE_EXPECT=${expect_count}
PANIC_SURFACE_BASELINE_PANIC=${panic_count}
PANIC_SURFACE_BASELINE_TOTAL=${total_count}
BASELINE
}

case "$MODE" in
  snapshot)
    print_counts
    write_baseline
    echo "wrote baseline: $BASELINE_FILE"
    ;;
  check)
    if [[ ! -f "$BASELINE_FILE" ]]; then
      echo "missing panic-surface baseline: $BASELINE_FILE" >&2
      echo "run: scripts/panic-surface-gate.sh snapshot" >&2
      exit 1
    fi

    # shellcheck source=/dev/null
    source "$BASELINE_FILE"

    print_counts
    echo "panic-surface baseline:"
    echo "  unwrap=${PANIC_SURFACE_BASELINE_UNWRAP}"
    echo "  expect=${PANIC_SURFACE_BASELINE_EXPECT}"
    echo "  panic=${PANIC_SURFACE_BASELINE_PANIC}"
    echo "  total=${PANIC_SURFACE_BASELINE_TOTAL}"

    if (( unwrap_count > PANIC_SURFACE_BASELINE_UNWRAP )) || \
       (( expect_count > PANIC_SURFACE_BASELINE_EXPECT )) || \
       (( panic_count > PANIC_SURFACE_BASELINE_PANIC )) || \
       (( total_count > PANIC_SURFACE_BASELINE_TOTAL )); then
      echo "panic-surface gate failed: no-net-growth policy violated" >&2
      exit 1
    fi

    echo "panic-surface gate passed"
    ;;
  *)
    echo "usage: scripts/panic-surface-gate.sh [check|snapshot]" >&2
    exit 2
    ;;
esac
