# Build and push the OpenAgents runtime image.
#
# IMPORTANT: submit with repository root context so Cargo workspace metadata is available.
#
# Run from repo root:
#   gcloud builds submit \
#     --config apps/runtime/deploy/cloudbuild.yaml \
#     --substitutions _TAG="$(git rev-parse --short HEAD)" \
#     .
substitutions:
  _TAG: ${SHORT_SHA}

steps:
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -f
      - apps/runtime/Dockerfile
      - -t
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-runtime/runtime-rust:${_TAG}
      - -t
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-runtime/runtime-rust:latest-rust
      - .

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-runtime/runtime-rust:${_TAG}

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-runtime/runtime-rust:latest-rust

images:
  - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-runtime/runtime-rust:${_TAG}
  - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-runtime/runtime-rust:latest-rust

options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
